#!/usr/bin/env bash

source .env

lux assets

# assets deploy
rsync -vrh ./public/assets/ "$PRODUCTION_SERVER:$PRODUCTION_PATH/public/assets"

# copy app
rsync -vrh \
  --executability \
  --delete \
  --exclude 'log/*' \
  --exclude '.env' \
  --exclude 'tmp/*' \
  --exclude '.git/*' \
  --exclude 'public/assets/*' \
  --exclude 'node_modules/*' \
  --exclude 'lux/*' \
  . $PRODUCTION_SERVER:$PRODUCTION_PATH

# copy lux
rsync -vrh \
  --executability \
  --delete \
  --exclude 'log/*' \
  --exclude '.env' \
  --exclude 'tmp/*' \
  --exclude '.git/*' \
  ../lux/ "$PRODUCTION_SERVER:$PRODUCTION_PATH/lux"

# install and login
ssh -t $PRODUCTION_SERVER "
  echo '$PRODUCTION_PASS' | sudo -S echo;
  set -x;
  source ~/.bashrc;
  cd $PRODUCTION_PATH;
  /home/deployer/.rbenv/shims/bundle install;
  /home/deployer/.rbenv/shims/bundle exec $PRODUCTION_PATH/lux/bin/lux am;
  sudo service nginx restart;"

